#!/usr/bin/env bash
set -e

COMMAND=$1
SUBCOMMAND=$2

case "$COMMAND" in
  run)
    case "$SUBCOMMAND" in
      project)
        echo "ğŸš€ Initializing FastAPI project..."

        echo "ğŸ”¹ Creating virtual environment"
        python3 -m venv venv
	source venv/bin/activate

        echo "ğŸ”¹ Installing FastAPI and dependencies"
        pip install "fastapi[all]"
        pip install sqlalchemy
        pip install alembic

        echo "ğŸ”¹ Creating main.py"
        cat <<EOF > main.py
'''
core file for start app
'''

from fastapi import Body, FastAPI, Query, status, HTTPException, Path, UploadFile, File, Depends

app = FastAPI()

'''
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                  Import Routers              â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
'''

EOF

        echo "ğŸ”¹ Creating .env and .env.example"
        touch .env .env.example

        echo "ğŸ”¹ Creating .gitignore"
        cat <<EOF > .gitignore
__pycache__
venv
.env
.env.example
.dockerignore
*.log
.idea
.vscode
EOF

        echo "ğŸ”¹ Creating Dockerfile"
        touch Dockerfile

        echo "ğŸ”¹ Creating docker-compose.yaml"
        touch docker-compose.yaml

        echo "ğŸ”¹ Creating .dockerignore"
        cat <<EOF > .dockerignore
__pycache__
venv
.env
.dockerignore
EOF

        echo "ğŸ”¹ Creating README.md"
        touch README.md

        echo "ğŸ”¹ Freezing requirements"
        pip freeze > requirements.txt

        echo "ğŸ”¹ Creating config module"
        mkdir -p config
        touch config/__init__.py

        echo "ğŸ”¹ Creating config/config.py"
        cat <<'EOF' > config/config.py
'''
set enviroment settings
'''

'''
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                  Import Modules              â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
'''

from pydantic_settings import BaseSettings
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent



'''
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                   Settings                   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
'''

class Settings(BaseSettings):
    SQLALCHEMY_DATABASE_URL: str

    model_config = {
        "env_file": BASE_DIR / ".env",
        "env_file_encoding": "utf-8",
    }

settings = Settings()
EOF

        echo "ğŸ”¹ Creating config/database.py"
        cat <<'EOF' > config/database.py
'''
data base config
'''

'''
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                  Import Modules              â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
'''
from sqlalchemy.orm import sessionmaker, declarative_base
from sqlalchemy import create_engine
from . config import settings


engine = create_engine(
    settings.SQLALCHEMY_DATABASE_URL,                    # database adress
    pool_pre_ping=True,                                  
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()

session = SessionLocal()

def get_db():
    db = SessionLocal()

    try:
        yield db

    finally:
        db.close()
EOF

	mkdir -p alembic
	cd alembic || exit 1
	alembic init migrations

	ENV_FILE="migrations/env.py"

	echo "ğŸ”¹ Patching Alembic env.py"

	# 1ï¸âƒ£ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† import Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† indent)
	grep -q "from config.config import settings" "$ENV_FILE" || \
	sed -i '/from alembic import context/a\
from config.config import settings\
from config.database import Base\
	' "$ENV_FILE"

	# 2ï¸âƒ£ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ target_metadata = None Ø¨Ø§ Ø¨Ù„Ø§Ú© ØªÙ…ÛŒØ²
	awk '
	/^target_metadata = None$/ {
	    print "database_url = settings.SQLALCHEMY_DATABASE_URL.replace(\"%\", \"%%\")"
	    print ""
	    print "config.set_main_option("
	    print "    \"sqlalchemy.url\","
	    print "    database_url,"
	    print ")"
	    print ""
	    print "target_metadata = Base.metadata"
	    next
	}
	{ print }
	' "$ENV_FILE" > /tmp/env.py && mv /tmp/env.py "$ENV_FILE"

	cd ..



        echo "âœ… FastAPI project initialized successfully"
        ;;
      *)
        echo "âŒ Unknown subcommand"
        exit 1
        ;;
    esac
    ;;
  *)
    echo "âŒ Unknown command"
    exit 1
    ;;
esac


